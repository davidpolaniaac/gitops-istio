---
apiVersion: helm.integrations.flux.weave.works/v1alpha2
kind: FluxHelmRelease
metadata:
  name: frontend
  namespace: demo
  annotations:
    flux.weave.works/automated: "true"
    flux.weave.works/tag.blue: semver:~1.1
    flux.weave.works/tag.green: semver:~1.2
spec:
  chartGitPath: podinfo-istio
  releaseName: frontend
  values:
    host: podinfo.istio.weavedx.com
    exposeHost: true

    blue:
      replicas: 2
      image: quay.io/stefanprodan/podinfo:1.1.1
      backend: http://backend.demo.svc.cluster.local:9898/api/echo

    green:
      replicas: 2
      image: quay.io/stefanprodan/podinfo:1.2.1
      routing:
        # target Safari
      - match:
        - headers:
            user-agent:
              regex: "^(?!.*Chrome).*Safari.*"
        # target API clients by version
      - match:
        - headers:
            x-api-version:
              regex: "^(v{0,1})1\\.2\\.([0-9]).*"
      backend: http://backend.demo.svc.cluster.local:9898/api/echo

